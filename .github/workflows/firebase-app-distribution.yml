name: Deploy to Firebase App Distribution

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    name: Build and Deploy App
    runs-on: ubuntu-latest

    steps:
        - name: Checkout code
          uses: actions/checkout@v3

        - name: Setup Java
          uses: actions/setup-java@v3
          with:
            distribution: 'temurin'
            java-version: '17'
            cache: 'gradle'

        - name: Setup Flutter
          uses: subosito/flutter-action@v2
          with:
            cache: true
            flutter-version: '3.35.2'                        
            channel: 'stable'

        - name: Cache Flutter dependencies
          uses: actions/cache@v3
          with:
            path: |
              ~/.pub-cache
              .dart_tool
            key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
            restore-keys: |
              ${{ runner.os }}-flutter-

        - name: Install dependencies
          run: flutter pub get

        - name: Build APK
          run: flutter build apk --release
        
        - name: Deploy to Firebase App Distribution
          uses: wzieba/Firebase-Distribution-Github-Action@v1
          with:
            serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
            appId: ${{ secrets.FIREBASE_APP_ID }}
            groups: 'dev'
            file: build/app/outputs/flutter-apk/app-release.apk
            releaseNotes: |
              New test build available!
              
              ${{ github.event.head_commit.message }}
              
              Commit: ${{ github.sha }}
              Branch: ${{ github.ref_name }}
              Author: ${{ github.actor }}

              View changes: https://github.com/${{ github.repository }}/commit/${{ github.sha }}

        - name: Upload APK artifact
          uses: actions/upload-artifact@v4
          with:
            name: app-release
            path: build/app/outputs/flutter-apk/app-release.apk
            retention-days: 30